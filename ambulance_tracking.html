<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Ambulance Tracking</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
      body {
        font-family: system-ui;
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      .legend {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 500px"></div>
    <div class="legend">
      <b>Legend:</b><br />
      ğŸš‘ Ambulance<br />
      ğŸ“ Pickup Location<br />
      ğŸ¥ Hospital
    </div>

    <script>
      //Firebase setup---->
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:9d31ba29b95928346fca25",
        measurementId: "G-TSHRR7T645",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

  // Leaflet map
  var map = L.map("map").setView([20.5937, 78.9629], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const pickupMarkers = {};

  // Start live ambulance tracking
  function startLiveTracking(id) {
    setInterval(() => {
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        db.ref("requests/" + id).update({
          ambulanceLat: lat,
          ambulanceLng: lng,
          status: "En Route",
        });

        // Move ambulance marker on map
        if (!ambulanceMarker) {
          ambulanceMarker = L.marker([lat, lng], {
            icon: L.divIcon({ html: "ğŸš‘", iconSize: [24, 24] }),
          }).addTo(map);
        } else {
          ambulanceMarker.setLatLng([lat, lng]);
        }
        map.setView([lat, lng], 15);
      });
    }, 5000);
  }

  // Accept request
  function acceptRequest(id) {
    navigator.geolocation.getCurrentPosition((pos) => {
      db.ref("requests/" + id).update({
        status: "Accepted",
        ambulanceLat: pos.coords.latitude,
        ambulanceLng: pos.coords.longitude,
      });
      alert("ğŸš‘ Request Accepted!");
      startLiveTracking(id);
    });
  }

  // Listen for NEW requests
  db.ref("requests").on("child_added", (snapshot) => {
    const req = snapshot.val();
    const id = snapshot.key;

    if (req?.pickup?.lat && req?.pickup?.lng) {
      const marker = L.marker([req.pickup.lat, req.pickup.lng], {
        icon: L.divIcon({ html: "ğŸ“", iconSize: [24, 24] }),
      }).addTo(map);

      pickupMarkers[id] = marker;

      marker.bindPopup(`
        <b>ğŸš¨ New Request</b><br>
        Patient: ${req.patientName || "Unknown"}<br>
        Priority: ${req.priority}<br>
        Notes: ${req.notes || "-"}<br>
        <button onclick="acceptRequest('${id}')">Accept Request</button>
      `).openPopup();

      map.setView([req.pickup.lat, req.pickup.lng], 14);

      alert("ğŸš¨ New ambulance request received!");
    }
  });
    </script>
  </body>
</html>
